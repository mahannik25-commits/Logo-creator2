<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>لوگو شاپ</title>

<link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

const ADMIN_EMAIL = "mahannik25@gmail.com";

const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default';

let auth, db, storage;
let isAdmin = false;
let products = [];

const provider = new GoogleAuthProvider();

function init() {
    const app = initializeApp(firebaseConfig);
    auth = getAuth(app);
    db = getFirestore(app);
    storage = getStorage(app);

    onAuthStateChanged(auth, user => {
        isAdmin = user && user.email === ADMIN_EMAIL;
        document.getElementById("admin-login").classList.toggle("hidden", isAdmin);
        listen();
    });
}

window.loginAdmin = async () => {
    try {
        await signInWithPopup(auth, provider);
    } catch (e) {
        alert("ورود انجام نشد");
    }
};

function listen() {
    const col = collection(db, `artifacts/${appId}/public/data/logos`);
    onSnapshot(query(col), snap => {
        products = [];
        snap.forEach(d => products.push({ id: d.id, ...d.data() }));
        render();
    });
}

function render() {
    const grid = document.getElementById("grid");
    grid.innerHTML = "";

    products
    .filter(p => isAdmin || p.approved === true)
    .forEach(p => {
        const div = document.createElement("div");
        div.className = "bg-white p-4 rounded-xl shadow";

        div.innerHTML = `
            <img src="${p.imageUrl}" class="h-40 w-full object-contain mb-2">
            <h3 class="font-bold">${p.title}</h3>
            <p class="text-sm mb-2">${p.description}</p>
            ${isAdmin ? `
                ${!p.approved ? `<button class="approve bg-green-600 text-white px-3 py-1 rounded mr-2">تأیید</button>` : ``}
                <button class="remove bg-red-600 text-white px-3 py-1 rounded">حذف</button>
            ` : ``}
        `;

        if (isAdmin) {
            div.querySelector(".approve")?.addEventListener("click", () => approve(p.id));
            div.querySelector(".remove").addEventListener("click", () => removeLogo(p.id, p.imageUrl));
        }

        grid.appendChild(div);
    });

    lucide.createIcons();
}

window.uploadLogo = async e => {
    e.preventDefault();
    const file = logoFile.files[0];
    if (!file) return;

    const refFile = ref(storage, `logos/${Date.now()}_${file.name}`);
    await uploadBytes(refFile, file);
    const url = await getDownloadURL(refFile);

    await addDoc(collection(db, `artifacts/${appId}/public/data/logos`), {
        title: logoTitle.value,
        description: "ارسالی کاربر",
        imageUrl: url,
        approved: false,
        createdAt: serverTimestamp()
    });

    alert("لوگو ارسال شد");
    e.target.reset();
};

async function approve(id) {
    await updateDoc(doc(db, `artifacts/${appId}/public/data/logos/${id}`), { approved: true });
}

async function removeLogo(id, url) {
    if (!confirm("حذف شود؟")) return;
    await deleteObject(ref(storage, url));
    await deleteDoc(doc(db, `artifacts/${appId}/public/data/logos/${id}`));
}

document.addEventListener("DOMContentLoaded", init);
</script>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col font-sans">

<header class="bg-white p-5 flex justify-between items-center shadow">
    <h1 class="text-2xl font-bold">لوگو شاپ</h1>
    <button id="admin-login" onclick="loginAdmin()" class="bg-indigo-600 text-white px-4 py-2 rounded">
        ورود ادمین
    </button>
</header>

<main class="flex-grow max-w-5xl mx-auto p-5">

<section class="bg-white p-5 rounded-xl shadow mb-6">
    <h2 class="font-bold mb-3">آپلود لوگو</h2>
    <form onsubmit="uploadLogo(event)" class="space-y-3">
        <input id="logoTitle" required placeholder="عنوان لوگو" class="w-full border p-2 rounded">
        <input id="logoFile" type="file" accept="image/*" required class="w-full border p-2 rounded">
        <button class="bg-indigo-600 text-white w-full py-2 rounded">
            آپلود
        </button>
    </form>
</section>

<section>
    <h2 class="font-bold mb-3">گالری لوگوها</h2>
    <div id="grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-5"></div>
</section>

</main>

<footer class="bg-white border-t text-center p-5">
    <p class="text-gray-600 mb-2">
        برای ثبت سفارش خود در تلگرام با ما در تماس باشید.
    </p>
    <a href="https://t.me/Logo_design103" target="_blank" class="text-indigo-600 font-bold">
        کانال تلگرام
    </a>
</footer>

</body>
</html>